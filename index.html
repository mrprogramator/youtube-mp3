<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"  name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <link rel="icon" type="image/png" href="img/logo.png" />
        <title>coco</title>
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
        <link href="/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
        <link href="/css/index.css" rel="stylesheet">
        <link href="/css/menu.css" rel="stylesheet">
        <link href="/css/play.css" rel="stylesheet">
    </head>
    <body>
        <div style="height:56px;background:rgb(35,35,35);position:fixed;top:0px;width:100%;z-index:1">
            <table style="width:100%">
                <tr>
                    <td class="btn-toggle-menu" onclick="toggleSideMenu()" style="vertical-align:middle;width:50px;text-align:right">
                            <i class="fa fa-bars fa-2x" style="margin:14px"></i>
                    </td>
                    <td style="vertical-align:middle;width:50px;text-align:right">
                        <div style="border-radius: 7px;background: #009688;padding: 0px 7px;font-size: 21px;font-weight: bold;text-align: center;display:inline-block;width:20px">
                            c
                        </div> 
                    </td>
                    <td style="vertical-align:middle;width:127px">
                        <text style="font-weight:bold;font-size:1.7em;">coco</text>
                    </td>
                    <td style="vertical-align:middle">
                        <form onsubmit="return handleSearch()">
                            <input id="search-input" type="search" style="background:hsl(0, 0%, 7%);color:hsl(0, 0%, 100%);-webkit-appearance: none;-webkit-font-smoothing: antialiased;font-size: 16px;font-weight: 400;line-height: 24px;margin-left: 4px;padding-left:7px;width:100%;max-width:591px;border:1px solid hsl(0, 0%, 18.82%);border-radius:2px" autofocus/>
                            <button type="submit" style="cursor: pointer;display:inline-block;text-align:center;width: 65px;border: 1px solid hsl(0, 0%, 18.82%);background-color: hsla(0, 0%, 100%, .08);border-radius: 0 2px 2px 0;margin: 0;color:hsla(0, 100%, 100%, .5);padding:4px;font-size:1.4em">
                                <i class="fa fa-search"></i>
                            </button>
                        </form>
                    </td>
                </tr>
            </table>
        </div>
        <div id="side-menu" style="padding-top:68px;position:fixed;top:0px;width:240px;background:#1c1c1c;height:100%;overflow:hidden">
        </div>
        <div id="results" style="margin-left:240px;padding:14px;padding-top:56px;">
        </div>
        <div id="playlists" style="margin-left:240px;padding:14px;padding-top:56px;height:100%;display:none"></div>
        <script src="js/request.js"></script>
        <script src="js/time.js"></script>
        <script src="js/list-templates.js"></script>
        <script src="js/search.js"></script>
        <script src="js/trending.js"></script>
        <script src="js/playlists.js"></script>
        <script src="js/menu.js"></script>
        <script src="/node_modules/socket.io-client/dist/socket.io.js"></script>
        <script src="js/download.js"></script>
        
        <script>
            var deviceLanguage;
            var loadingHTML = "<div style=\"padding-top:20%;text-align:center\"><i class=\"fa fa-cog fa-4x fa-spin\"></i></div>";
            var videoLoadTimeout = null;
            
            window.onload = function () {
                deviceLanguage = navigator.language;
                (deviceLanguage && deviceLanguage.indexOf('es') >= 0? document.getElementById('search-input').placeholder = "Buscar" : document.getElementById('search-input').placeholder = "Search" );
                showHome();
            }

            function handleSearch(){
                var resultsDiv = document.getElementById('results');
                var searchInput = document.getElementById('search-input');
                var indication = searchInput.value;
                var playlistsDiv = document.getElementById('playlists');
                playlistsDiv.style.display = 'none';
                resultsDiv.style.display = '';
                resultsDiv.innerHTML = loadingHTML;
                
                search(indication, 7, function (results){
                    resultsDiv.innerHTML = getListTemplate(results);
                }, function () {
                    resultsDiv.innerHTML = "<div style=\"text-align:center\">"
                        + "<i class=\"fa fa-bug\"> Error"
                    +"</div>";
                });

                document.getElementById('side-menu').innerHTML = getMenuTemplate('home');
                return false;
            }

            function handlePlay(videoId, videoTitle, channelTitle, publishedAt, imgUrl){
                window.scrollTo(0,0);
                var resultsDiv = document.getElementById('results');
                var playlistsDiv = document.getElementById('playlists');
                resultsDiv.style.display = 'none';
                playlistsDiv.style.display = '';
                playlistsDiv.innerHTML = loadingHTML;

                loadPlaylists(function (results){
                    playlistsDiv.innerHTML = getPlaylistsTemplate(results, videoId, videoTitle, channelTitle, publishedAt, imgUrl);
                    
                    document.getElementsByTagName('video')[0].addEventListener('progress', onVideoLoaded);
                    document.getElementsByTagName('video')[0].addEventListener('error', onVideoError);
                    
                    videoLoadTimeout = setTimeout(onVideoError, 300000);

                    var similarTracksDiv = document.getElementById('similar-tracks');
                    similarTracksDiv.innerHTML = loadingHTML;
                    
                    search(channelTitle, 14, function (results){
                        results.items = results.items.filter(function (r) { return r.id.videoId != videoId });
                        similarTracksDiv.innerHTML = getListTemplate(results);
                    }, function(){
                        similarTracksDiv.innerHTML = '';
                    });

                }, function(){
                    playlistsDiv.innerHTML = "<div style=\"text-align:center\">"
                        + "<i class=\"fa fa-bug\"> Error"
                    +"</div>";
                })

                document.getElementById('side-menu').innerHTML = getMenuTemplate('playlists');
            }

            function onVideoLoaded(){
                if(this.duration){
                    clearTimeout(videoLoadTimeout);
                    document.getElementById('loading-video-div').style.display = 'none';
                    this.style.display = '';
                    this.removeEventListener('progress', onVideoLoaded);
                }
            }

            function onVideoError(){
                document.getElementById('loading-video-div').innerHTML = "<i class=\"fa fa-bug fa-4x\"></i><br>"
                + (deviceLanguage && deviceLanguage.indexOf('es') >= 0? "Error al cargar el v&iacute;deo" : "Could not load video");
            }

            function showHome(){
                var resultsDiv = document.getElementById('results');
                var playlistsDiv = document.getElementById('playlists');
                playlistsDiv.style.display = 'none';
                resultsDiv.style.display = '';
                resultsDiv.innerHTML = loadingHTML;

                loadTrending(8, function (results){
                    resultsDiv.innerHTML = getBoxTemplate(results);
                }, function (){
                    resultsDiv.innerHTML = "<div style=\"text-align:center\">"
                        + "<i class=\"fa fa-bug\"> Error"
                    +"</div>";
                })

                document.getElementById('side-menu').innerHTML = getMenuTemplate('home');
            }

            function showTrending(){
                var resultsDiv = document.getElementById('results');
                var playlistsDiv = document.getElementById('playlists');
                playlistsDiv.style.display = 'none';
                resultsDiv.style.display = '';
                resultsDiv.innerHTML = loadingHTML;

                loadTrending(50, function (results){
                    resultsDiv.innerHTML = getListTemplate(results);
                }, function (){
                    resultsDiv.innerHTML = "<div style=\"text-align:center\">"
                        + "<i class=\"fa fa-bug\"> Error"
                    +"</div>";
                })

                document.getElementById('side-menu').innerHTML = getMenuTemplate('trending');
            }

            function showPlaylists() {
                var resultsDiv = document.getElementById('results');
                var playlistsDiv = document.getElementById('playlists');
                resultsDiv.style.display = 'none';
                playlistsDiv.style.display = '';
                if(playlistsDiv.innerHTML.length === 0){
                    playlistsDiv.innerHTML = loadingHTML;

                    loadPlaylists(function (results){
                        playlistsDiv.innerHTML = getPlaylistsTemplate(results);
                    }, function(){
                        playlistsDiv.innerHTML = "<div style=\"text-align:center\">"
                            + "<i class=\"fa fa-bug\"> Error"
                        +"</div>";
                    })
                }

                document.getElementById('side-menu').innerHTML = getMenuTemplate('playlists');
            }

            function toggleSideMenu(){
                var sideMenu = document.getElementById('side-menu');
                var resultsDiv = document.getElementById('results');
                var playlistsDiv = document.getElementById('playlists');
                
                if(sideMenu.style.display == 'none'){
                    sideMenu.style.display = '';
                }
                else{
                    sideMenu.style.display = 'none';
                }

                resultsDiv.style['margin-left'] = sideMenu.offsetWidth + 'px';
                playlistsDiv.style['margin-left'] = sideMenu.offsetWidth + 'px';
            }

        </script>
    </body>
</html>